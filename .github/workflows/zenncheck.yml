name: Check Zenn API and Deploy

on:
  schedule:
    - cron: "0 */3 * * *" # æ¯æ—¥0æ™‚ã€3æ™‚ã€6æ™‚...ã«å®Ÿè¡Œ
  workflow_dispatch:

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
permissions:
  contents: read # gh workflow runã‚³ãƒãƒ³ãƒ‰ã®ãŸã‚

jobs:
  check-zenn-updates:
    runs-on: ubuntu-latest

    outputs:
      has-changes: ${{ steps.check-diff.outputs.has-changes }}

    steps:
      # å‰å›ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å¾©å…ƒ
      - name: Restore previous Zenn hash
        id: cache-zenn
        uses: actions/cache/restore@v4
        with:
          path: zenn-previous-hash.txt
          key: zenn-hash

      # Zenn APIã‹ã‚‰æœ€æ–°è¨˜äº‹ã‚’å–å¾—ã—ã¦ãƒãƒƒã‚·ãƒ¥åŒ–
      - name: Fetch and hash Zenn data
        run: |
          echo "ğŸ“¡ Zenn APIã‹ã‚‰æœ€æ–°è¨˜äº‹ã‚’å–å¾—ä¸­..."

          # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã—ã¦SHA256ãƒãƒƒã‚·ãƒ¥åŒ–
          if ! curl -sf --max-time 30 "https://zenn.dev/api/articles?username=gouki_main&order=latest&page=1" \
               | sha256sum | cut -d' ' -f1 > zenn-current-hash.txt; then
            echo "âŒ Zenn APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ãƒãƒƒã‚·ãƒ¥å€¤: $(cat zenn-current-hash.txt)"

      # å‰å›ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨æ¯”è¼ƒ
      - name: Check for changes
        id: check-diff
        run: |
          if [ ! -f zenn-previous-hash.txt ]; then
            echo "âš ï¸ å‰å›ã®ãƒãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“(åˆå›å®Ÿè¡Œã¾ãŸã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œ)"
            echo "has-changes=true" >> $GITHUB_OUTPUT
          elif diff -q zenn-previous-hash.txt zenn-current-hash.txt > /dev/null; then
            echo "âœ… å¤‰æ›´ãªã—: Zennè¨˜äº‹ã«æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“"
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ å¤‰æ›´ã‚ã‚Š: Zennè¨˜äº‹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"
            echo "å‰å›: $(cat zenn-previous-hash.txt)"
            echo "ä»Šå›: $(cat zenn-current-hash.txt)"
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi

      # ç¾åœ¨ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’æ¬¡å›ç”¨ã«ä¿å­˜
      # NOTE: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯7æ—¥é–“ã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„ã¨è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™
      - name: Save current Zenn hash
        if: success()
        uses: actions/cache/save@v4
        with:
          path: zenn-current-hash.txt
          key: zenn-hash

      # å·®åˆ†ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
      - name: Trigger deployment workflow
        if: steps.check-diff.outputs.has-changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ“ Zennè¨˜äº‹ã«æ›´æ–°ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ã€‚"
          gh workflow run deploy.yml \
            --repo ${{ github.repository }} \
            --ref ${{ github.ref_name }}
